<html>
<head>
<title>Pattern marker example with Three.js</title>
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
<style>
html,body {
	margin: 0;
	padding: 0;
	width: 100%;
	text-align: center;
	overflow-x: hidden;
}
.isHidden {
  opacity: 0;
  pointer-events: none;
}
a-scene {
	position: absolute;
	top: 0;
	left: 0;
}
#enemyTitle {
  font-size: 1em;
	line-height: 1.5em;
  color: white;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
	height: 100%;
	width: 100%;
	font-family: sans-serif;
	position: relative;
	z-index: 1000;
}
#battleOverlay {
	position: absolute;
	z-index: 9;
	top: 0;
	left: 0;
	color: white;
	height: 100%;
	width: 100%;
	background-color: rgba(0, 0, 0, 0.3);
}
.enemyStats {
	display: flex;
	flex-direction: column;
	align-items: flex-start;
	width: 13em;
	font-weight: 100;
	background-color: rgba(0, 0, 0, 0.7);
}
.enemyStats div {
	padding: .1em;
	padding-left: .3em;
	padding-right: .3em;
}
.enemyName {
	display: flex;
	width: 12.5em;
	justify-content: space-between;
}
.divider {
	margin-top: .2em;
	margin-bottom: .2em;
	border-bottom: 1px solid white;
	width: 13em;
}
.loot {
	display: flex;
	flex-direction: column;
	align-items: flex-start;
}
.loot div {
	margin-left: .5em;
	font-size: .9em;
}
.loot div:first-of-type {
	padding-left: 0;
	margin-left: 0;
	font-size: 1em;
}
#soloFight, #multiFight {
	cursor: pointer;
	width: 13em;
	height: 1.5em;
	display: flex;
	align-items: center;
	justify-content: center;
}
</style>
</head>

  <body style='margin : 0px; overflow: hidden;'>
    <!-- <script src="https://aframe.io/releases/0.8.0/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/1.6.0/aframe/build/aframe-ar.js"></script> -->
    <!-- pre fight title screen -->
     <div id="enemyTitle" class="isHidden">
       <div class="enemyStats">
         <div class="enemyName"><span>Cactaur</span><span>Lvl. 20</span></div>
         <span class="divider"></span>
         <div>HP: 1000/1000</div>
         <div>MP: 50/50</div>
         <div>EXP: 20,000</div>
         <div class="loot">
           <div>Loot:</div>
           <div>Rare: Katana</div>
           <div>Common: Hi-Potion</div>
         </div>
         <span class="divider"></span>
         <div id="soloFight">Solo Battle</div>
         <span class="divider"></span>
         <div id="multiFight">Multi Battle</div>
       </div>
    </div>
    <div id="battleOverlay" class="isHidden">
      <div id="message-current"></div>
      <div id="message-bossName"></div>
      <div>
        HP
        <span id="message-bossHp"></span>/<span id="message-bossMaxHp"></span>
      </div>
      <div>
        HP
        <span id="message-playerHp"></span>/<span id="message-playerMaxHp"></span>
      </div>
      <button id="attack">Attack</button>
      <button id="heal">Heal</button>
    </div>
      <!-- https://github.com/jeromeetienne/AR.js/blob/master/README.md -->
      <!-- Markercode from here -->
      <!-- https://aframe.io/blog/arjs/#move-the-camera-or-the-marker -->
    	<a-scene style="position: absolute;" embedded arjs='sourceType: webcam;'>
        <a-marker id="a-marker" preset='hiro'>
          <a-plane src="cactaur.png" position='0 0.5 0' material='opacity: 1;' rotation='-90 0 0' width="2" height="2"></a-plane>
        </a-marker>
        <!-- define a simple camera -->
        <a-entity camera></a-entity>
    	</a-scene>
  </body>
  <script>
    var queueCounter = 0;
    var soloFight = document.getElementById('soloFight');
    var multiFight = document.getElementById('multiFight');
    var markerFound = false;
    var playerId = Math.random().toFixed(3).toString().replace('0.', '');
    // waiting for marker to be found after page is loaded
    document.getElementById('enemyTitle').classList.remove('isHidden'); //debug
    // uncomment below for release
    // var hideBattle = setInterval(() => {
    //   if (document.getElementById('a-marker').object3D.visible) {
    //     // https://github.com/artoolkit/artoolkit5/blob/master/doc/patterns/Hiro%20pattern.pdf
    //     // https://stackoverflow.com/questions/44799413/how-to-detect-when-marker-is-found-in-ar-js
    //     document.getElementById('enemyTitle').classList.remove('isHidden');
    //     markerFound = true;
    //     clearInterval(hideBattle);
    //   }
    // }, 500);

    // init game state
    let cactaur = {
      name: 'Cactaur',
      attack: '100',
      actions: ['100 needles', '10 needles', '1 needle', 'Cactaur is thinking about an escape!'], // add an easy attack to help win?
      escapes: ['knows it\'s time escape!', 'is packing its needles!', 'is turning around!'],
      dead: false,
      hp: 1000,
      maxHp: 1000,
      escapeCounter: 0,
      '100 needles': 100,
      '10 needles': 10,
      '1 needle': 1,
    }
    let player = {
      number: 1,
      hp: 300,
      maxHp: 300,
      attack: 100,
      critical: 300,
      heal: 100,
      actions: ['attack', 'critical', 'miss']
    }
    let gameState = {
      id: 'solo',
      queue: ['boss', '001'],
      queueCounter: 0,
      playerActions: [],
      actionCounter: 0,
      boss: cactaur,
      currentMessage: 'Battle Start!',
      playerMap: {
        '001': player
      },
      win: false,
      lose: false,
      gameover: false,
    }

    soloFight.addEventListener('click', () => {
      playerId = '001';
      document.getElementById('enemyTitle').classList.add('isHidden');
      document.getElementById('battleOverlay').classList.remove('isHidden');
      console.log('starting solo')

      // no need for server at this point, we'll just run game loop on client
      // in a full version we would need to go through server to prevent cheating

      // game loop logic
      let bossTurn = (gameState) => {
        if (gameState.boss.escapeCounter === 3) {
          gameState.currentMessage = 'Cactaur ran away!'
          gameState.lose = true;
          return gameState;
        }
        // determine if boss is under 50%;
        if (gameState.boss.hp <= (gameState.boss.maxHp / 2)) {
          // activate escape counter
          console.log('escape counter increment')
          gameState.currentMessage = 'Cactaur ' + gameState.boss.escapes[gameState.boss.escapeCounter];
          gameState.boss.escapeCounter += 1;
          gameState.queueCounter += 1;
          return gameState;
        }
        // based on queue minus 0 index
        let randomAction = gameState.boss.actions[Math.floor(Math.random() * (gameState.boss.actions.length))];
        let randomTarget = Math.floor(Math.random() * (gameState.queue.length - 1) + 1);
        console.log(randomAction, randomTarget)
        if (gameState.boss[randomAction]) {
          let dmg = gameState.boss[randomAction];
          let playerToDmg = gameState.playerMap[gameState.queue[randomTarget]];
          playerToDmg.hp -= dmg;
          gameState.currentMessage = 'Player ' + playerToDmg.number + ' was damaged for ' + dmg + 'HP!'
          gameState.queueCounter += 1;
          console.log(playerToDmg, dmg, gameState.currentMessage)
        }
        return gameState
      }
      let playerTurn = (gameState, playerKey) => {
        // process action array
        let action = gameState.playerActions[gameState.actionCounter];
        if (action.dmg) {
          gameState.boss.hp -= action.dmg;
          gameState.currentMessage = action.msg;
        }
        gameState.actionCounter += 1;
        gameState.queueCounter += 1;
        if (gameState.queueCounter >= gameState.queue.length) {
          gameState.queueCounter = 0;
          console.log('boss turn')
        }
        console.log('PLAYERRUN', gameState.currentMessage)
        return gameState;
      }
      let gameLoop = (gameState) => {
        var nextTurnKey = gameState.queue[gameState.queueCounter]
        console.log(nextTurnKey)
        let playerAction = gameState.playerActions[gameState.actionCounter];
        if (nextTurnKey === 'boss') {
          return bossTurn(gameState);
        } else if (playerAction && playerAction.owner === nextTurnKey) {
          console.log('action found')
          return playerTurn(gameState, nextTurnKey);
        } else {
          gameState.currentMessage = 'Waiting for Player ' + gameState.playerMap[nextTurnKey].number;
          return gameState;
        }
      }
      document.getElementById('message-bossName').innerText = gameState.boss.name;
      document.getElementById('message-playerMaxHp').innerText = gameState.playerMap[playerId].maxHp;
      document.getElementById('message-bossMaxHp').innerText = gameState.boss.maxHp;
      let updateDisplay = (gameState) => {
        let currentMsg = document.getElementById('message-current')
        let bossHp = document.getElementById('message-bossHp')
        let playerHp = document.getElementById('message-playerHp')
        // update player hp
        playerHp.innerText = gameState.playerMap[playerId].hp;
        // update boss hp
        bossHp.innerText = gameState.boss.hp;
        // update current message
        currentMsg.innerText = gameState.currentMessage;
        console.log('UPDATE', gameState.currentMessage)
      }
      updateDisplay(gameState);
      // gameloop
      let game = setInterval(() => {
        let newState = gameLoop(gameState);
        console.log('NEWSTATE', newState.currentMessage)
        if (newState.gameover) {
          updateDisplay(gameState);
          clearInterval(game);
        }
        updateDisplay(newState);

      }, 1000)
    })
    let attackButton = document.getElementById('attack');
    attackButton.addEventListener('click', () => {
      if (gameState.id === 'solo') {
        console.log('offline attack')
        let playerNumber = gameState.playerMap[playerId].number;
        let action = { owner: playerId, dmg: 0, msg: 'Player ' + playerNumber + ' missed!' }
        let isHit = Math.random();
        let isCritical = Math.random();
        if (isHit > .33) {
          action.dmg = player.attack
          action.msg = 'Player ' + playerNumber + ' hit Cactaur for ' + action.dmg + 'HP!'
          if (isCritical > .8) {
            action.dmg = player.critical
            action.msg = 'Player ' + playerNumber + ' hit Cactaur for ' + action.dmg + 'HP! Critical!'
          }
        }
        gameState.playerActions.push(action);
      }
    })
  </script>
















</html>
